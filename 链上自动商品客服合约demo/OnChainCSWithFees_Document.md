# OnChainCSWithFees 文档

## 概述

本文件包含收费版（方案五）合约说明、数据字典以及系统流程图。

------------------------------------------------------------------------

## 1. 数据字典（Data Dictionary）

### Product

-   **id**: 商品ID\
-   **merchant**: 商家地址\
-   **name**: 商品名称\
-   **price**: 商品价格（wei）\
-   **exists**: 是否存在\
-   **metaCID**: 可选的商品元数据 CID

### Order

-   **purchased**: 是否下单\
-   **confirmedDelivery**: 是否确认收货\
-   **reviewed**: 是否已评价\
-   **purchaseTimestamp**: 下单时间\
-   **shippingAddressCID**: 收货地址 CID\
-   **rewardAmount**: 返现金额（ERC20 最小单位）

### 关键参数

-   **rewardToken**: 用作返现的 ERC20\
-   **feeToken**: 用作订阅与关键词收费的 ERC20\
-   **rewardRatePerMille**: 返现比例（默认千分之 5 → 0.5%）\
-   **platformFeePerMille**: 平台抽成比例（默认千分之 10 → 奖励的 1%）\
-   **merchantSubscriptionFee**: 商家订阅费\
-   **keywordOneTimeFee**: 非订阅商家单次关键词费用\
-   **subscriptionExpiry**: 商家订阅到期时间

------------------------------------------------------------------------

## 2. 流程图（Mermaid）

### 商品购买 + 评价返现流程

``` mermaid
flowchart TD

A[用户发起购买] --> B{是否支付商品金额正确?}
B -- 否 --> B1[拒绝交易]
B -- 是 --> C[创建订单 purchased=true]

C --> D[用户确认收货]
D --> D1[订单 confirmedDelivery=true]

D1 --> E[提交评价 reviewCID + 图片CIDs]
E --> E1{是否满足 “100字+5图”?}
E1 -- 否 --> E2[拒绝发放奖励]
E1 -- 是 --> F[计算返现]

F --> G[检查奖励池余额充足?]
G -- 否 --> G1[拒绝, 奖励池不足]
G -- 是 --> H[给用户发放 rewardToken]

H --> I[平台收取平台抽成]
I --> J[流程结束]
```

------------------------------------------------------------------------

## 3. 商家订阅 / 关键词收费流程

``` mermaid
flowchart TD

M[商家设置关键词] --> N{商家是否订阅?}
N -- 是 --> O[免费设置关键词]
N -- 否 --> P[商家支付 keywordOneTimeFee]
P --> O
O --> Q[关键词写入链上]
```

------------------------------------------------------------------------

## 4. 奖励池充值流程

``` mermaid
flowchart TD

X[商家 / 平台调用 fundRewards()] --> Y[rewardToken 转入合约] --> Z[奖励池余额增加]
```

------------------------------------------------------------------------

## 5. 合约作用总结

-   商家可订阅（按月）以免除关键词付费\
-   未订阅商家需按次付费设置 auto-reply\
-   用户购买、确认收货、评价 → 获得返现\
-   平台从奖励中抽成\
-   平台/商家可为奖励池充值\
-   全链上流程可被前端监听（事件）

------------------------------------------------------------------------

生成时间：自动生成
